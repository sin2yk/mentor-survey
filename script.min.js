(function () { 'use strict'; const G = 'YOUR_GAS_WEB_APP_URL_HERE', S = 'YOUR_SECRET_KEY_HERE', M = ['中村 ひろき', '杉本 至', '紫竹 佑騎', '小島 淳', '大谷 祐司', '山崎 拓也', '茂木 健一', '増渕 大輔', '本多 太一', '深野 彌', '平下 公洋', '中農 稔（ねろ）', '長峯 広雅', '佐野 健', '近藤 祥子', '小菅 達矢', '河畠 輝', '藤川 真一（えふしん）', '山本 憲', '和田 康宏', '森 豪基（もりご）', '橋本 正德', '大村 幸寛', '奥屋 孝太郎', '小川 博教']; const pr = new URLSearchParams(location.search), md = pr.get('mode') === 'test' ? 'test' : 'prod', t0 = performance.now(); const f = document.getElementById('survey-form'), t = document.getElementById('thank-you'), tn = document.getElementById('thank-you-note'), tb = document.getElementById('test-banner'), q2 = document.getElementById('q2-section'), ws = document.getElementById('wine-story'), cr = document.getElementById('remaining'), sb = document.getElementById('submit-btn'), mr = document.querySelectorAll('input[name="mentor"]'), wr = document.querySelectorAll('input[name="wine"]'); if (md === 'test' && tb) tb.style.display = 'block'; if (md === 'prod' && localStorage.getItem('mentorpoll_answered') === 'true') { f.style.display = 'none'; t.style.display = 'block'; return } let ms = null, wv = null, is = false; function u() { const r = wv === 'A', v = !r || (ws && ws.value.trim().length > 0); sb.disabled = !(ms && wv && v) } mr.forEach(r => r.addEventListener('change', e => { ms = e.target.value; u() })); wr.forEach(r => r.addEventListener('change', e => { wv = e.target.value; q2.style.display = wv === 'A' ? 'block' : 'none'; u() })); if (ws) ws.addEventListener('input', () => { const rm = 300 - ws.value.length; cr.textContent = rm; cr.parentElement.style.color = rm < 30 ? 'rgba(220,38,38,.9)' : ''; u() }); async function p(d) { const r = await fetch(G, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(d) }); if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json() } function e() { sb.textContent = '再送する'; sb.disabled = false; sb.classList.add('btn-retry'); is = false } sb.addEventListener('click', async () => { if (is || sb.disabled) return; is = true; sb.disabled = true; sb.textContent = '送信中...'; sb.classList.remove('btn-retry'); if (!M.includes(ms)) { alert('無効な選択です。'); is = false; sb.disabled = false; sb.textContent = '送信する'; return } const dm = Math.round(performance.now() - t0), d = { secret: S, mode: md, mentor_name: ms, q1_choice: wv, q2_text: wv === 'A' ? ws.value.trim() : '', duration_ms: dm, timezone: Intl.DateTimeFormat().resolvedOptions().timeZone, user_agent: navigator.userAgent }; try { const r = await p(d); if (r.success) { if (md === 'prod') localStorage.setItem('mentorpoll_answered', 'true'); f.style.display = 'none'; t.style.display = 'block'; t.classList.add('fade-in'); if (md === 'test' && tn) tn.style.display = 'block' } else throw new Error(r.error || 'Error') } catch (x) { console.error(x); e() } }); u() })();
